services:
  # Main trading bot - runs cron-based autonomous trading
  trading-bot:
    build: .
    environment:
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_SECRET_KEY=${ALPACA_SECRET_KEY}
      - ALPACA_PAPER_TRADE=${ALPACA_PAPER_TRADE:-True}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - POLYGON_API_KEY=${POLYGON_API_KEY:-}
      - TWITTER_API_KEY=${TWITTER_API_KEY:-}
      - TWITTER_API_SECRET=${TWITTER_API_SECRET:-}
      - TWITTER_ACCESS_TOKEN=${TWITTER_ACCESS_TOKEN:-}
      - TWITTER_ACCESS_TOKEN_SECRET=${TWITTER_ACCESS_TOKEN_SECRET:-}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - ENABLE_STOCK_TRADING=${ENABLE_STOCK_TRADING:-true}
      - ENABLE_CRYPTO_TRADING=${ENABLE_CRYPTO_TRADING:-false}
      - ENABLE_OPTIONS_TRADING=${ENABLE_OPTIONS_TRADING:-false}
      - TZ=America/New_York
      - STATE_DIR=/data/alpaca-bot
    volumes:
      - bot-data:/data/alpaca-bot
    restart: unless-stopped
    # Uses default entrypoint (cron-based trading bot)

  # MCP server for manual/HTTP access (optional)
  mcp-server:
    build: .
    environment:
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_SECRET_KEY=${ALPACA_SECRET_KEY}
      - ALPACA_PAPER_TRADE=${ALPACA_PAPER_TRADE:-True}
    ports:
      - "8001:8000"
    command: ["python", "alpaca_mcp_server.py", "--transport", "http", "--host", "0.0.0.0"]
    profiles:
      - mcp  # Only starts with: docker compose --profile mcp up

volumes:
  bot-data:
    # Persists state.json, plan.md, strategy.md, and logs
